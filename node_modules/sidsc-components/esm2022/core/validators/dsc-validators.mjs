import { isEmpty, isNotEmpty } from '../utils/string.util';
import { isEmptyArray, isNotEmptyArray } from '../utils/array.util';
import { FileUploadTypes } from './file-upload-files.enum';
import { formatDataStorageUnits } from '../utils/common.util';
export class DscValidators {
    static min(min) {
        return minValidator(min);
    }
    static max(max) {
        return maxValidator(max);
    }
    static maxTotalFileSize(maxTotalSize) {
        return maxTotalFileSizeValidator(maxTotalSize);
    }
}
export function minValidator(min) {
    return (control) => {
        if (isEmpty(control.value) || isNaN(min))
            return null;
        const value = parseFloat(control.value);
        return !isNaN(value) && value < min
            ? { 'min': { 'min': min, 'actual': control.value } }
            : null;
    };
}
export function maxValidator(max) {
    return (control) => {
        if (isEmpty(control.value) || isNaN(max))
            return null;
        const value = parseFloat(control.value);
        return !isNaN(value) && value > max
            ? { 'max': { 'max': max, 'actual': control.value } }
            : null;
    };
}
export function acceptValidator(accept) {
    return (control) => {
        if (!accept)
            return null;
        const value = control.value;
        const accepts = acceptResolver(accept);
        if (Array.isArray(value)) {
            return handleFileArray(value, accepts);
        }
        else {
            return handleSingleFile(value, accepts);
        }
    };
}
function handleFileArray(files, accepts) {
    if (isEmptyArray(files))
        return null;
    const notAllowedFiles = files.map(file => checkFileTypes(file, accepts)).filter(Boolean);
    return notAllowedFiles.length > 0 ? { 'notAllowedFile': notAllowedFiles } : null;
}
function handleSingleFile(file, accepts) {
    if (!file)
        return null;
    const notAllowedFile = checkFileTypes(file, accepts);
    return notAllowedFile ? { 'notAllowedFile': notAllowedFile } : null;
}
function acceptResolver(accept) {
    const values = accept.replace(/\s/g, '').split(',');
    return isNotEmptyArray(values) ? values.slice() : [];
}
function checkFileTypes(file, accepts) {
    if (!file)
        return null;
    const FILE_EXT_REG = /(^[.]\w*)$/m;
    // @ts-ignore
    const fileExtension = file.name.split('.').pop().toLowerCase();
    const fileType = getFileType(file, fileExtension);
    // @ts-ignore
    const isFound = accepts.some(type => FILE_EXT_REG.test(type) ? type === `.${fileExtension}` : new RegExp(type).test(fileType));
    return isFound ? null : { allowedTypes: accepts, actual: fileType, file };
}
function getFileType(file, fileExtension) {
    const type = file.type;
    if (isNotEmpty(type))
        return type;
    // @ts-ignore
    return FileUploadTypes[fileExtension];
}
export function maxTotalFileSizeValidator(maxTotalSize) {
    return (control) => {
        const value = control.value;
        let sum = 0;
        if (Array.isArray(value)) {
            if (isEmptyArray(value))
                return null;
            sum = value.map(file => file.size).reduce((a, b) => a + b, 0);
        }
        else {
            if (!value)
                return null;
            sum = value.size;
        }
        // @ts-ignore
        const toLargeFile = checkFileSize(sum, maxTotalSize);
        return toLargeFile ? { 'fileSizeOverLimit': toLargeFile } : null;
    };
}
function checkFileSize(actualSize, maxSize) {
    return (Number.isInteger(maxSize) && actualSize > maxSize)
        ? { maxSize, actualSize, actualSizeFriendly: formatDataStorageUnits(actualSize), maxSizeFriendly: formatDataStorageUnits(maxSize) }
        : null;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHNjLXZhbGlkYXRvcnMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9zaWRzYy1jb21wb25lbnRzL2NvcmUvdmFsaWRhdG9ycy9kc2MtdmFsaWRhdG9ycy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxPQUFPLEVBQUUsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQzNELE9BQU8sRUFBRSxZQUFZLEVBQUUsZUFBZSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDcEUsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQzNELE9BQU8sRUFBRSxzQkFBc0IsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBRTlELE1BQU0sT0FBTyxhQUFhO0lBQ3hCLE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBVztRQUNwQixPQUFPLFlBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUMzQixDQUFDO0lBRUQsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFXO1FBQ3BCLE9BQU8sWUFBWSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQzNCLENBQUM7SUFFRCxNQUFNLENBQUMsZ0JBQWdCLENBQUMsWUFBb0I7UUFDMUMsT0FBTyx5QkFBeUIsQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUNqRCxDQUFDO0NBQ0Y7QUFFRCxNQUFNLFVBQVUsWUFBWSxDQUFDLEdBQVc7SUFDdEMsT0FBTyxDQUFDLE9BQXdCLEVBQXlCLEVBQUU7UUFDekQsSUFBSSxPQUFPLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLEtBQUssQ0FBQyxHQUFHLENBQUM7WUFBRSxPQUFPLElBQUksQ0FBQztRQUN0RCxNQUFNLEtBQUssR0FBRyxVQUFVLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3hDLE9BQU8sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLElBQUksS0FBSyxHQUFHLEdBQUc7WUFDakMsQ0FBQyxDQUFD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SUFBSSxDQUFDO1lBQ3JDLEdBQUcsR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7U0FDL0Q7YUFBTTtZQUNMLElBQUksQ0FBQyxLQUFLO2dCQUFFLE9BQU8sSUFBSSxDQUFDO1lBQ3hCLEdBQUcsR0FBVSxLQUFNLENBQUMsSUFBSSxDQUFDO1NBQzFCO1FBQ0QsYUFBYTtRQUNiLE1BQU0sV0FBVyxHQUFHLGFBQWEsQ0FBQyxHQUFHLEVBQUUsWUFBWSxDQUFDLENBQUM7UUFDckQsT0FBTyxXQUFXLENBQUMsQ0FBQyxDQUFDLEVBQUUsbUJBQW1CLEVBQUUsV0FBVyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztJQUNuRSxDQUFDLENBQUM7QUFDSixDQUFDO0FBRUQsU0FBUyxhQUFhLENBQ3BCLFVBQWtCLEVBQ2xCLE9BQWU7SUFFZixPQUFPLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsSUFBSSxVQUFVLEdBQUcsT0FBTyxDQUFDO1FBQ3hELENBQUMsQ0FBQyxFQUFFLE9BQU8sRUFBRSxVQUFVLEVBQUUsa0JBQWtCLEVBQUUsc0JBQXNCLENBQUMsVUFBVSxDQUFDLEVBQUUsZUFBZSxFQUFFLHNCQUFzQixDQUFDLE9BQU8sQ0FBQyxFQUFFO1FBQ25JLENBQUMsQ0FBQyxJQUFJLENBQUM7QUFDWCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQWJzdHJhY3RDb250cm9sLCBWYWxpZGF0aW9uRXJyb3JzLCBWYWxpZGF0b3JGbiB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcblxuaW1wb3J0IHsgaXNFbXB0eSwgaXNOb3RFbXB0eSB9IGZyb20gJy4uL3V0aWxzL3N0cmluZy51dGlsJztcbmltcG9ydCB7IGlzRW1wdHlBcnJheSwgaXNOb3RFbXB0eUFycmF5IH0gZnJvbSAnLi4vdXRpbHMvYXJyYXkudXRpbCc7XG5pbXBvcnQgeyBGaWxlVXBsb2FkVHlwZXMgfSBmcm9tICcuL2ZpbGUtdXBsb2FkLWZpbGVzLmVudW0nO1xuaW1wb3J0IHsgZm9ybWF0RGF0YVN0b3JhZ2VVbml0cyB9IGZyb20gJy4uL3V0aWxzL2NvbW1vbi51dGlsJztcblxuZXhwb3J0IGNsYXNzIERzY1ZhbGlkYXRvcnMge1xuICBzdGF0aWMgbWluKG1pbjogbnVtYmVyKTogVmFsaWRhdG9yRm4ge1xuICAgIHJldHVybiBtaW5WYWxpZGF0b3IobWluKTtcbiAgfVxuXG4gIHN0YXRpYyBtYXgobWF4OiBudW1iZXIpOiBWYWxpZGF0b3JGbiB7XG4gICAgcmV0dXJuIG1heFZhbGlkYXRvcihtYXgpO1xuICB9XG5cbiAgc3RhdGljIG1heFRvdGFsRmlsZVNpemUobWF4VG90YWxTaXplOiBudW1iZXIpOiBWYWxpZGF0b3JGbiB7XG4gICAgcmV0dXJuIG1heFRvdGFsRmlsZVNpemVWYWxpZGF0b3IobWF4VG90YWxTaXplKTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gbWluVmFsaWRhdG9yKG1pbjogbnVtYmVyKTogVmFsaWRhdG9yRm4ge1xuICByZXR1cm4gKGNvbnRyb2w6IEFic3RyYWN0Q29udHJvbCk6IFZhbGlkYXRpb25FcnJvcnN8bnVsbCA9PiB7XG4gICAgaWYgKGlzRW1wdHkoY29udHJvbC52YWx1ZSkgfHwgaXNOYU4obWluKSkgcmV0dXJuIG51bGw7XG4gICAgY29uc3QgdmFsdWUgPSBwYXJzZUZsb2F0KGNvbnRyb2wudmFsdWUpO1xuICAgIHJldHVybiAhaXNOYU4odmFsdWUpICYmIHZhbHVlIDwgbWluXG4gICAgICA/IHsgJ21pbic6IHsgJ21pbic6IG1pbiwgJ2FjdHVhbCc6IGNvbnRyb2wudmFsdWUgfSB9XG4gICAgICA6IG51bGw7XG4gICAgfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1heFZhbGlkYXRvcihtYXg6IG51bWJlcik6IFZhbGlkYXRvckZuIHtcbiAgcmV0dXJuIChjb250cm9sOiBBYnN0cmFjdENvbnRyb2wpOiBWYWxpZGF0aW9uRXJyb3JzfG51bGwgPT4ge1xuICAgIGlmIChpc0VtcHR5KGNvbnRyb2wudmFsdWUpIHx8IGlzTmFOKG1heCkpIHJldHVybiBudWxsO1xuICAgIGNvbnN0IHZhbHVlID0gcGFyc2VGbG9hdChjb250cm9sLnZhbHVlKTtcbiAgICByZXR1cm4gIWlzTmFOKHZhbHVlKSAmJiB2YWx1ZSA+IG1heFxuICAgICAgPyB7ICdtYXgnOiB7ICdtYXgnOiBtYXgsICdhY3R1YWwnOiBjb250cm9sLnZhbHVlIH0gfVxuICAgICAgOiBudWxsO1xuICB9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gYWNjZXB0VmFsaWRhdG9yKGFjY2VwdDogc3RyaW5nIHwgdW5kZWZpbmVkKTogVmFsaWRhdG9yRm4ge1xuICByZXR1cm4gKGNvbnRyb2w6IEFic3RyYWN0Q29udHJvbCk6IFZhbGlkYXRpb25FcnJvcnMgfCBudWxsID0+IHtcbiAgICBpZighYWNjZXB0KSByZXR1cm4gbnVsbDtcblxuICAgIGNvbnN0IHZhbHVlOiBBcnJheTxGaWxlPiB8IEZpbGUgPSBjb250cm9sLnZhbHVlO1xuICAgIGNvbnN0IGFjY2VwdHMgPSBhY2NlcHRSZXNvbHZlcihhY2NlcHQpO1xuXG4gICAgaWYoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcbiAgICAgIHJldHVybiBoYW5kbGVGaWxlQXJyYXkodmFsdWUsIGFjY2VwdHMpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gaGFuZGxlU2luZ2xlRmlsZSh2YWx1ZSwgYWNjZXB0cyk7XG4gICAgfVxuICB9O1xufVxuXG5mdW5jdGlvbiBoYW5kbGVGaWxlQXJyYXkoZmlsZXM6IEFycmF5PEZpbGU+LCBhY2NlcHRzOiBzdHJpbmdbXSk6IFZhbGlkYXRpb25FcnJvcnMgfCBudWxsIHtcbiAgaWYoaXNFbXB0eUFycmF5KGZpbGVzKSkgcmV0dXJuIG51bGw7XG5cbiAgY29uc3Qgbm90QWxsb3dlZEZpbGVzID0gZmlsZXMubWFwKGZpbGUgPT4gY2hlY2tGaWxlVHlwZXMoZmlsZSwgYWNjZXB0cykpLmZpbHRlcihCb29sZWFuKTtcbiAgcmV0dXJuIG5vdEFsbG93ZWRGaWxlcy5sZW5ndGggPiAwID8geyAnbm90QWxsb3dlZEZpbGUnOiBub3RBbGxvd2VkRmlsZXMgfSA6IG51bGw7XG59XG5cbmZ1bmN0aW9uIGhhbmRsZVNpbmdsZUZpbGUoZmlsZTogRmlsZSwgYWNjZXB0czogc3RyaW5nW10pOiBWYWxpZGF0aW9uRXJyb3JzIHwgbnVsbCB7XG4gIGlmKCFmaWxlKSByZXR1cm4gbnVsbDtcblxuICBjb25zdCBub3RBbGxvd2VkRmlsZSA9IGNoZWNrRmlsZVR5cGVzKGZpbGUsIGFjY2VwdHMpO1xuICByZXR1cm4gbm90QWxsb3dlZEZpbGUgPyB7ICdub3RBbGxvd2VkRmlsZSc6IG5vdEFsbG93ZWRGaWxlIH0gOiBudWxsO1xufVxuXG5mdW5jdGlvbiBhY2NlcHRSZXNvbHZlcihhY2NlcHQ6IHN0cmluZyk6IHN0cmluZ1tdIHtcbiAgY29uc3QgdmFsdWVzID0gYWNjZXB0LnJlcGxhY2UoL1xccy9nLCAnJykuc3BsaXQoJywnKTtcbiAgcmV0dXJuIGlzTm90RW1wdHlBcnJheSh2YWx1ZXMpID8gdmFsdWVzLnNsaWNlKCkgOiBbXTtcbn1cblxuZnVuY3Rpb24gY2hlY2tGaWxlVHlwZXMoZmlsZTogRmlsZSwgYWNjZXB0czogc3RyaW5nW10pOiBWYWxpZGF0aW9uRXJyb3JzIHwgbnVsbCB7XG4gIGlmICghZmlsZSkgcmV0dXJuIG51bGw7XG4gIGNvbnN0IEZJTEVfRVhUX1JFRyA9IC8oXlsuXVxcdyopJC9tO1xuICAvLyBAdHMtaWdub3JlXG4gIGNvbnN0IGZpbGVFeHRlbnNpb24gPSBmaWxlLm5hbWUuc3BsaXQoJy4nKS5wb3AoKS50b0xvd2VyQ2FzZSgpO1xuICBjb25zdCBmaWxlVHlwZSA9IGdldEZpbGVUeXBlKGZpbGUsIGZpbGVFeHRlbnNpb24pO1xuICAvLyBAdHMtaWdub3JlXG4gIGNvbnN0IGlzRm91bmQgPSBhY2NlcHRzLnNvbWUodHlwZSA9PlxuICAgIEZJTEVfRVhUX1JFRy50ZXN0KHR5cGUpID8gdHlwZSA9PT0gYC4ke2ZpbGVFeHRlbnNpb259YCA6IG5ldyBSZWdFeHAodHlwZSkudGVzdChmaWxlVHlwZSlcbiAgKTtcbiAgcmV0dXJuIGlzRm91bmQgPyBudWxsIDogeyBhbGxvd2VkVHlwZXM6IGFjY2VwdHMsIGFjdHVhbDogZmlsZVR5cGUsIGZpbGUgfTtcbn1cblxuZnVuY3Rpb24gZ2V0RmlsZVR5cGUoZmlsZTogRmlsZSwgZmlsZUV4dGVuc2lvbjogc3RyaW5nKTogRmlsZVVwbG9hZFR5cGVzIHtcbiAgY29uc3QgdHlwZSA9IGZpbGUudHlwZTtcbiAgaWYgKGlzTm90RW1wdHkodHlwZSkpIHJldHVybiB0eXBlIGFzIEZpbGVVcGxvYWRUeXBlcztcbiAgLy8gQHRzLWlnbm9yZVxuICByZXR1cm4gRmlsZVVwbG9hZFR5cGVzW2ZpbGVFeHRlbnNpb25dO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbWF4VG90YWxGaWxlU2l6ZVZhbGlkYXRvcihtYXhUb3RhbFNpemU6IG51bWJlcik6IFZhbGlkYXRvckZuIHtcbiAgcmV0dXJuIChjb250cm9sOiBBYnN0cmFjdENvbnRyb2wpOiBWYWxpZGF0aW9uRXJyb3JzfG51bGwgPT4ge1xuICAgIGNvbnN0IHZhbHVlOiBBcnJheTxGaWxlPiB8IEZpbGUgPSBjb250cm9sLnZhbHVlO1xuICAgIGxldCBzdW0gPSAwO1xuICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkge1xuICAgICAgaWYgKGlzRW1wdHlBcnJheSh2YWx1ZSkpIHJldHVybiBudWxsO1xuICAgICAgc3VtID0gdmFsdWUubWFwKGZpbGUgPT4gZmlsZS5zaXplKS5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKCF2YWx1ZSkgcmV0dXJuIG51bGw7XG4gICAgICBzdW0gPSAoPEZpbGU+dmFsdWUpLnNpemU7XG4gICAgfVxuICAgIC8vIEB0cy1pZ25vcmVcbiAgICBjb25zdCB0b0xhcmdlRmlsZSA9IGNoZWNrRmlsZVNpemUoc3VtLCBtYXhUb3RhbFNpemUpO1xuICAgIHJldHVybiB0b0xhcmdlRmlsZSA/IHsgJ2ZpbGVTaXplT3ZlckxpbWl0JzogdG9MYXJnZUZpbGUgfSA6IG51bGw7XG4gIH07XG59XG5cbmZ1bmN0aW9uIGNoZWNrRmlsZVNpemUoXG4gIGFjdHVhbFNpemU6IG51bWJlcixcbiAgbWF4U2l6ZTogbnVtYmVyXG4pOiBWYWxpZGF0aW9uRXJyb3JzIHwgbnVsbCB7XG4gIHJldHVybiAoTnVtYmVyLmlzSW50ZWdlcihtYXhTaXplKSAmJiBhY3R1YWxTaXplID4gbWF4U2l6ZSlcbiAgICA/IHsgbWF4U2l6ZSwgYWN0dWFsU2l6ZSwgYWN0dWFsU2l6ZUZyaWVuZGx5OiBmb3JtYXREYXRhU3RvcmFnZVVuaXRzKGFjdHVhbFNpemUpLCBtYXhTaXplRnJpZW5kbHk6IGZvcm1hdERhdGFTdG9yYWdlVW5pdHMobWF4U2l6ZSkgfVxuICAgIDogbnVsbDtcbn1cbiJdfQ==